# .github/workflows/keep-alive.yml

name: ğŸŒ¡ï¸ Cloudflare Dynamic Cache Warmer

# ======================= 1. è§¦å‘è®¾ç½® =======================
on:
  # æ¯ 30 åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼Œç”¨äºä¿æŒ Function æ´»è·ƒå’Œç¼“å­˜æ–°é²œ
  schedule:
    - cron: '*/30 * * * *'
  # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:
  
# å·¥ä½œæµæƒé™è®¾ç½®
permissions:
  contents: read

jobs:
  ping_and_warm:
    runs-on: ubuntu-latest
    name: Get Routes and Warm Cache

    # ======================= 2. ç¯å¢ƒå˜é‡ =======================
    env:
      # âš ï¸ å¿…é¡»è®¾ç½®çš„ Secret: æ‚¨çš„ Cloudflare Pages éƒ¨ç½²åœ°å€
      BASE_URL: ${{ secrets.CLOUDFLARE_PAGES_URL || 'https://www.dinosawmachine.com' }}
      # âš ï¸ ä¸“ç”¨äºè·å–è·¯ç”±åˆ—è¡¨çš„ API è·¯å¾„ï¼ˆéœ€åœ¨ Nuxt server/api ä¸­å®ç°ï¼‰
      ROUTES_API_PATH: /api/sitemap-routes 
      # é¢å¤–æ·»åŠ å°‘é‡å…³é”®çš„é™æ€è·¯ç”±æˆ–å¿…é¡»ç¡®ä¿ç¼“å­˜æ–°é²œçš„è·¯ç”±
      STATIC_ROUTES_TO_WARM: |
        /
        /Products
        /blog
        /About-us
        /contact
      
    steps:
      # ======================= 3. æ£€æŸ¥ç¯å¢ƒå˜é‡ =======================
      - name: ğŸ” Check Environment
        run: |
          echo "Base URL: ${{ env.BASE_URL }}"
          echo "Routes API Path: ${{ env.ROUTES_API_PATH }}"
          if [ -z "${{ env.BASE_URL }}" ]; then
            echo "âŒ BASE_URL is not set!"
            exit 1
          fi

      # ======================= 4. åŠ¨æ€è·å–è·¯ç”±åˆ—è¡¨ =======================
      - name: â¬‡ï¸ Fetch Dynamic Routes from API
        id: fetch_routes
        continue-on-error: true
        run: |
          # ç¡®ä¿å®‰è£… jq å·¥å…·æ¥è§£æ JSON
          sudo apt-get update && sudo apt-get install -y jq
          
          API_URL="${{ env.BASE_URL }}${{ env.ROUTES_API_PATH }}"
          echo "Fetching routes from: $API_URL"
          
          # ä½¿ç”¨ curl è·å– JSON æ•°ç»„ï¼Œå¹¶ä½¿ç”¨ jq è§£æä¸ºæ¢è¡Œç¬¦åˆ†éš”çš„å­—ç¬¦ä¸²
          ROUTES=$(curl -s --max-time 30 --retry 3 "$API_URL" | jq -r '.[]' 2>/dev/null || echo "")
          
          if [ -z "$ROUTES" ]; then
            echo "âš ï¸ Warning: API returned an empty list of dynamic routes or failed."
            ROUTES=""
          else
            echo "âœ… Successfully fetched $(echo "$ROUTES" | wc -l) dynamic routes"
          fi
          
          # å°†åŠ¨æ€è·¯ç”±åˆ—è¡¨è®¾ç½®ä¸ºä¸‹ä¸€æ­¥å¯ç”¨çš„è¾“å‡ºå˜é‡
          echo "ROUTES_TO_WARM<<EOF" >> $GITHUB_OUTPUT
          echo "$ROUTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      # ======================= 5. å¾ªç¯å¹¶é¢„çƒ­æ‰€æœ‰è·¯ç”± =======================
      - name: ğŸŒ Loop and Warm All Routes
        run: |
          # ç»„åˆé™æ€åˆ—è¡¨å’ŒåŠ¨æ€åˆ—è¡¨
          STATIC_LIST="${{ env.STATIC_ROUTES_TO_WARM }}"
          DYNAMIC_LIST="${{ steps.fetch_routes.outputs.ROUTES_TO_WARM }}"
          
          # å°†æ‰€æœ‰è·¯ç”±åˆå¹¶ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”
          ALL_ROUTES="$STATIC_LIST"$'\n'"$DYNAMIC_LIST"
          
          echo "ğŸ“‹ Found the following routes to warm:"
          echo "$ALL_ROUTES" | grep -v '^$' | head -20  # æ˜¾ç¤ºå‰20ä¸ªéç©ºè·¯ç”±
          
          # è®¡æ•°å™¨
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          TOTAL_COUNT=0
          
          # éå†æ‰€æœ‰è·¯ç”±å¹¶å‘é€è¯·æ±‚
          echo "$ALL_ROUTES" | while read -r route; do
            # ç¡®ä¿è·¯ç”±éç©º
            if [ -n "$route" ] && [ "$route" != " " ]; then
              TARGET_URL="${{ env.BASE_URL }}$route"
              echo "ğŸ”¥ Warming: $TARGET_URL"
              
              # å‘é€é¢„çƒ­è¯·æ±‚
              # -s: é™é»˜æ¨¡å¼ | -o /dev/null: å¿½ç•¥å“åº”ä½“ | -w: æ‰“å°çŠ¶æ€ç å’Œè€—æ—¶
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}|%{time_total}" \
                --max-time 15 \
                --retry 2 \
                --user-agent "GitHub-Actions-Cache-Warmer/1.0" \
                "$TARGET_URL" 2>/dev/null || echo "000|0")
              
              HTTP_CODE=$(echo "$RESPONSE" | cut -d'|' -f1)
              TIME_TOTAL=$(echo "$RESPONSE" | cut -d'|' -f2)
              
              TOTAL_COUNT=$((TOTAL_COUNT + 1))
              
              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                echo "  âœ… Status: $HTTP_CODE | Time: ${TIME_TOTAL}s"
              else
                FAIL_COUNT=$((FAIL_COUNT + 1))
                echo "  âŒ Status: $HTTP_CODE | Time: ${TIME_TOTAL}s"
              fi
              
              # æ·»åŠ å°å»¶è¿Ÿé¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
              sleep 0.5
            fi
          done
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  Total routes processed: $TOTAL_COUNT"
          echo "  Successful: $SUCCESS_COUNT"
          echo "  Failed: $FAIL_COUNT"
          
          # å¦‚æœå¤±è´¥ç‡è¿‡é«˜ï¼Œæ ‡è®°ä¸ºå¤±è´¥
          if [ $TOTAL_COUNT -gt 0 ] && [ $((FAIL_COUNT * 100 / TOTAL_COUNT)) -gt 50 ]; then
            echo "âŒ Too many failures (>50%), marking workflow as failed"
            exit 1
          fi