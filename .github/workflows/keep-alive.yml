# .github/workflows/keep-alive.yml

name: ğŸŒ¡ï¸ Cloudflare Dynamic Cache Warmer

# ======================= 1. è§¦å‘è®¾ç½® =======================
on:
  # æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼Œç”¨äºä¿æŒ Function æ´»è·ƒå’Œç¼“å­˜æ–°é²œ
  schedule:
    - cron: '*/5 * * * *'
  # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:
  
# å·¥ä½œæµæƒé™è®¾ç½®ï¼Œè¿™é‡Œè®¾ç½®ä¸º none ç¡®ä¿å®‰å…¨
permissions:
  contents: none

jobs:
  ping_and_warm:
    runs-on: ubuntu-latest
    name: Get Routes and Warm Cache

    # ======================= 2. ç¯å¢ƒå˜é‡ =======================
    env:
      # âš ï¸ å¿…é¡»è®¾ç½®çš„ Secret: æ‚¨çš„ Cloudflare Pages éƒ¨ç½²åœ°å€
      BASE_URL: ${{ secrets.CLOUDFLARE_PAGES_URL }}
      # âš ï¸ ä¸“ç”¨äºè·å–è·¯ç”±åˆ—è¡¨çš„ API è·¯å¾„ï¼ˆéœ€åœ¨ Nuxt server/api ä¸­å®ç°ï¼‰
      ROUTES_API_PATH: /api/sitemap-routes 
      # é¢å¤–æ·»åŠ å°‘é‡å…³é”®çš„é™æ€è·¯ç”±æˆ–å¿…é¡»ç¡®ä¿ç¼“å­˜æ–°é²œçš„è·¯ç”±
      STATIC_ROUTES_TO_WARM: |
        /
        /about
      
    steps:
      # ======================= 3. åŠ¨æ€è·å–è·¯ç”±åˆ—è¡¨ =======================
      - name: â¬‡ï¸ Fetch Dynamic Routes from API
        id: fetch_routes
        run: |
          # ç¡®ä¿å®‰è£… jq å·¥å…·æ¥è§£æ JSON
          sudo apt-get update && sudo apt-get install -y jq
          
          API_URL="${{ env.BASE_URL }}${{ env.ROUTES_API_PATH }}"
          echo "Fetching routes from: $API_URL"
          
          # ä½¿ç”¨ curl è·å– JSON æ•°ç»„ï¼Œå¹¶ä½¿ç”¨ jq è§£æä¸ºæ¢è¡Œç¬¦åˆ†éš”çš„å­—ç¬¦ä¸²
          ROUTES=$(curl -s "$API_URL" | jq -r '.[]')
          
          if [ -z "$ROUTES" ]; then
            echo "Warning: API returned an empty list of dynamic routes."
          fi
          
          # å°†åŠ¨æ€è·¯ç”±åˆ—è¡¨è®¾ç½®ä¸ºä¸‹ä¸€æ­¥å¯ç”¨çš„è¾“å‡ºå˜é‡
          echo "ROUTES_TO_WARM<<EOF" >> $GITHUB_OUTPUT
          echo "$ROUTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      # ======================= 4. å¾ªç¯å¹¶é¢„çƒ­æ‰€æœ‰è·¯ç”± =======================
      - name: ğŸŒ Loop and Warm All Routes
        run: |
          # ç»„åˆé™æ€åˆ—è¡¨å’ŒåŠ¨æ€åˆ—è¡¨
          STATIC_LIST="${{ env.STATIC_ROUTES_TO_WARM }}"
          DYNAMIC_LIST="${{ steps.fetch_routes.outputs.ROUTES_TO_WARM }}"
          
          # å°†æ‰€æœ‰è·¯ç”±åˆå¹¶ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”
          ALL_ROUTES="$STATIC_LIST"$'\n'"$DYNAMIC_LIST"
          
          echo "Found the following routes to warm:"
          echo "$ALL_ROUTES"
          
          # éå†æ‰€æœ‰è·¯ç”±å¹¶å‘é€è¯·æ±‚
          echo "$ALL_ROUTES" | while read -r route; do
            # ç¡®ä¿è·¯ç”±éç©º
            if [ -n "$route" ]; then
              TARGET_URL="${{ env.BASE_URL }}$route"
              echo "--- Warming: $TARGET_URL ---"
              
              # å‘é€é¢„çƒ­è¯·æ±‚
              # -s: é™é»˜æ¨¡å¼ | -o /dev/null: å¿½ç•¥å“åº”ä½“ | -w: æ‰“å°çŠ¶æ€ç å’Œè€—æ—¶
              curl -