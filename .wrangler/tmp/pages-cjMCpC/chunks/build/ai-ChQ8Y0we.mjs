import{_ as a}from"./NuxtImg-C1Be8NNh.mjs";import{_ as e}from"./_plugin-vue_export-helper-1tPrXgE0.mjs";import{v as t}from"./server.mjs";import{c as s,d as i,a as n,e as l,f as o,g as c}from"../routes/renderer.mjs";import{V as d}from"../_/nitro.mjs";const v={__name:"ai",__ssrInlineRender:!0,setup(e){const v=t.ref(!1),r=t.ref((new Date).getTime()+""),f=t.ref(0),u=t.ref(!1),p=t.ref(!1),h=t.ref(""),g=t.ref([{type:"bot",status:1,isTyping:!1,content:""}]),m=t.ref(!1),y=t.ref(!0);t.ref(0);const x=t.ref([]),b=t.ref({icon_url:"",onboarding_info:{prologue:""},shortcut_commands:[]}),w=t.ref(""),_=t.ref([]),$=t.ref(!1),S=t.ref({conversationId:0,content:"",fileList:[]}),z=t.ref(!1),T=t.ref(!1),I=t.ref([]),N=t.ref(null),O=t.ref(null),C=t.ref(!1),k=t.ref(!1),J=t.ref("");t.ref(null),t.ref([]);const R=t.ref(0),j=t.computed(()=>R.value>0?{height:`calc(100vh - ${R.value}px)`}:{height:"calc(100vh - 120px)"});let A=!1;t.watch(I,a=>{},{deep:!0}),t.watch(C,a=>{a&&(y.value?handleSendMessage():stopMessage(()=>{handleSendMessage()}),C.value=!1)});const handleSendMessage=()=>{if(!canSendMessage())return;const a=h.value,e=x.value;p.value=!0;const t={type:"user",status:1,content:a};if(f.value=0,e.length>0){const a={type:"user",status:1,content:"",image:[]};e.forEach(e=>{a.image.push({path:e.path,id:e.id})}),g.value=[...g.value,a]}""!==a.trim()&&(g.value=[...g.value,t]);let s={...S.value};""===s.content&&(""===a.trim()?s.fileList=e:s.content=a.trim(),S.value=s);let i=[...I.value];0===i.length?I.value=[s]:i[0].conversationId!==s.conversationId?(i=i.filter(a=>a.conversationId!==s.conversationId),I.value=[s,...i]):""===i[0].content?(i[0].content=a.trim(),I.value=i):I.value=i,g.value=[...g.value,{type:"bot",status:1,isTyping:!0,isShowToolResponse:!1,toolResponse:[],content:"dots-container"}],A=!1,pollingMessage()},pollingMessage=()=>{const a=h.value;let e=[],t=[];x.value.length>0?(x.value.forEach(a=>{let e={type:"image",file_id:a.id,file_url:a.path};t.push(e)}),t.push({type:"text",text:a}),e.push({role:"user",type:"question",content:JSON.stringify(t),content_type:"object_string"})):e.push({role:"user",type:"question",content:a,content_type:"text"}),h.value="",x.value=[];const s={method:"POST",headers:{Authorization:"","Content-Type":"application/json"},body:JSON.stringify({bot_id:"7494926120648409114",user_id:r.value,additional_messages:e,stream:!0}),signal:null};let i="",n="",l="0",o=0,c="",d=!1;const v=g.value.length-1;g.value[v].isTyping=!0,y.value=!1,A=!1;const displayMessage=()=>{if(A){const a=g.value.length-1;return g.value[a].isTyping=!1,y.value=!0,d=!1,void(A=!1)}const a=g.value.length-1;if(g.value[a].isTyping=!0,d=!0,o<n.length){let a=!0;if(c=n.slice(0,o),"<"===n[o]){let e=n.slice(o).search(/[\u4e00-\u9fa5]/);if(-1!==e?e+=o:e=n.indexOf(">",o),-1!==e){a=!1,c+=n.slice(o,e);const t=g.value.length-1;g.value[t].content=c,o=e+1}}if(a){c+=n[o];const a=g.value.length-1;g.value[a].content=c,o++}setTimeout(displayMessage,30)}else if(o>=n.length&&("4"===l||"5"===l)){const a=g.value.length-1;g.value[a].isTyping=!1,y.value=!0,d=!1}else setTimeout(displayMessage,30)},u=new AbortController,p=u.signal;N.value=u,s.signal=p,fetch(`https://api.coze.cn/v3/chat?conversation_id=${S.value.conversationId}`,s).then(a=>{const e=a.body.getReader();return function processStream(){return e.read().then(({done:a,value:e})=>{if(a)return;const t={data:e.buffer},s=new Uint8Array(t.data);let o="";try{o=decodeURIComponent(escape(String.fromCharCode.apply(null,s)))}catch(a){}const c=processStreamData(o);if(c.toolResponse&&c.toolResponse.length>0){const a=g.value.length-1;g.value[a].toolResponse=c.toolResponse}if("2"==c.answerStatus&&(f.value=c.chatId),"3"==c.answerStatus){i+=c.fullAnswer,n=i;const a=g.value.length-1;g.value[a].content.includes("dots-container")&&(g.value[a].content=""),!1===d&&(y.value=!1,displayMessage())}return"3"!=c.answerStatus&&"4"!=c.answerStatus&&"5"!=c.answerStatus||(l=c.answerStatus),processStream()})}()}).catch(a=>{console.error("请求失败:",a)})},cancelMessage=(a=()=>{})=>{fetch("https://api.coze.cn/v3/chat/cancel",{method:"POST",headers:{Authorization:"","Content-Type":"application/json"},body:JSON.stringify({conversation_id:S.value.conversationId,chat_id:f.value})}).then(a=>a.json()).then(e=>{a?a():y.value=!0}).catch(a=>{console.error("取消消息请求失败:",a)})},canSendMessage=()=>""!==h.value.trim()||x.value.length>0,stopMessage=(a=()=>{})=>{if(y.value=!0,A=!0,N.value){N.value.abort("User navigated away");for(let a=g.value.length-1;a>=0;a--)if("bot"===g.value[a].type&&g.value[a].isTyping){g.value[a]={...g.value[a],isTyping:!1,status:2,content:g.value[a].content};break}0!=f.value?a?cancelMessage(a):cancelMessage():setTimeout(()=>{a&&a()},100)}},processStreamData=a=>{let e="",t="",s="0",i=[],n=[];const l=a.split("\n");for(let a=0;a<l.length;a++){const o=l[a].trim();if(o.startsWith("event:conversation.chat.created")){s="1";const t=l[++a].trim();if(t.startsWith("data:")){const a=t.slice(5);try{const t=JSON.parse(a);""==e&&(e=t.id)}catch(a){console.error("解析 JSON 数据时出错:",a)}}}else o.startsWith("event:conversation.chat.in_progress")&&(s="2");if(o.startsWith("event:conversation.message.delta")){s="3";const e=l[++a].trim();if(e.startsWith("data:")){const a=e.slice(5);try{const e=JSON.parse(a);"assistant"===e.role&&"answer"===e.type&&(t+=e.content)}catch(a){console.error("解析 JSON 数据时出错:",a)}}}else if(o.startsWith("event:conversation.message.completed")){const e=l[++a].trim();if(e.startsWith("data:")){const a=e.slice(5);try{const e=JSON.parse(a);if("assistant"===e.role&&"answer"===e.type&&(s="4",t=e.content),"assistant"===e.role&&"follow_up"===e.type&&n.push(e.content),"assistant"===e.role&&"tool_response"===e.type){JSON.parse(e.content).data.doc_results&&(i=JSON.parse(e.content).data.doc_results)}}catch(a){console.error("解析 JSON 数据时出错:",a)}}}o.startsWith("event:conversation.chat.completed")&&(s="5")}return{fullAnswer:t,chatId:e,answerStatus:s,toolResponse:i,otherQuestion:n}};return(e,t,r,f)=>{const N=a;t(`<div${s(f)} data-v-f2f97022><div class="${i("mobile"===O.value?"chat-container":"chat-container pc")}" data-v-f2f97022><div class="chat-header" data-v-f2f97022><div class="icon-fanhui bar-back" data-v-f2f97022><div class="new-menu" data-v-f2f97022>`),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-newconversation.png"},null,r)),t('</div><div class="history-menu" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-menu.png",class:"history-menu-icon"},null,r)),t(`</div></div></div><div class="chat-content" style="${l(j.value)}" data-v-f2f97022><div style="${l(k.value?null:{display:"none"})}" data-v-f2f97022><div class="${i(["alert",`alert-${e.alertType}`])}" data-v-f2f97022>${o(J.value)}</div></div><div style="${l(v.value?null:{display:"none"})}" data-v-f2f97022><div class="loading-wrap" data-v-f2f97022><div class="loading-box" data-v-f2f97022><div class="loading" data-v-f2f97022>\x3c!--[--\x3e`),c(12,a=>{t('<div class="loading-icon__dot" data-v-f2f97022></div>')}),t("\x3c!--]--\x3e</div></div></div></div>"),p.value?t("\x3c!----\x3e"):(t('<div class="empty-content" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-logo.png",alt:"空内容",class:"empty-image"},null,r)),t('<div class="empty-text" data-v-f2f97022><div data-v-f2f97022> Expert AI for super-fast resolution of </div><div data-v-f2f97022>after-sales problems</div></div></div>')),p.value?(t('<div class="message-list" data-v-f2f97022>\x3c!--[--\x3e'),c(g.value,(a,e)=>{var s;t(`<div class="${i(["message-item","user"===a.type?"message-user":"message-bot"])}" data-v-f2f97022>`),"bot"===a.type?(t('<div class="normal-flex bot-name" data-v-f2f97022>'),t(n(N,{loading:"lazy",class:"avatar bot-avatar",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/bot-avatar.png",alt:"机器人头像"},null,r)),t('<span class="text" data-v-f2f97022> Dinosaw 鲨鱼哥 </span></div>')):t("\x3c!----\x3e"),t('<div class="message-bubble" data-v-f2f97022>'),a.image&&a.image.length>0?(t('<div class="message-file" data-v-f2f97022>\x3c!--[--\x3e'),c(a.image,(a,e)=>{t(n(N,{loading:"lazy",key:e,src:a.path,alt:"消息",class:"message-image",onClick:e=>{a.path}},null,r))}),t("\x3c!--]--\x3e</div>")):t("\x3c!----\x3e"),"user"===a.type?t(`<span class="message-text" data-v-f2f97022>${o(a.content)}</span>`):"dots-container"===a.content?t('<div class="dots-container" data-v-f2f97022><div class="dot" data-v-f2f97022></div><div class="dot" data-v-f2f97022></div><div class="dot" data-v-f2f97022></div></div>'):t(`<div class="message-text" data-v-f2f97022>${s=a.content,(s||"")??""}</div>`),2===a.status?t('<div class="message-stop" data-v-f2f97022> 已停止 </div>'):t("\x3c!----\x3e"),"bot"!==a.type||0===e||a.isTyping?t("\x3c!----\x3e"):(t('<div class="message-handle" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/icon-copy-black.png",alt:"复制",class:"message-handle-icon",onClick:e=>(async a=>{try{await(void 0).clipboard.writeText(a),J.value="复制成功",k.value=!0,setTimeout(()=>{k.value=!1},1500)}catch(a){console.error("复制失败:",a)}})(a.content)},null,r)),t("</div>")),t("</div></div>")}),t("\x3c!--]--\x3e</div>")):t("\x3c!----\x3e"),t(`<div class="content-bottom-bg" data-v-f2f97022></div></div><div class="${i("mobile"===O.value?"input-area":"input-area pc")}" data-v-f2f97022><div style="${l({position:"relative"})}" data-v-f2f97022><div class="${i(u.value?"shortcut-popup show":"shortcut-popup")}" data-v-f2f97022><div class="shortcut-title-wrap" data-v-f2f97022><div class="shortcut-title" data-v-f2f97022>${o(w.value)}</div><div class="close-btn" data-v-f2f97022></div></div><div class="list-scroll" data-v-f2f97022>\x3c!--[--\x3e`),c(_.value,(a,e)=>{t(`<div class="shortcut-item" data-v-f2f97022>${o(a)}</div>`)}),t('\x3c!--]--\x3e</div></div><div class="agent-config" data-v-f2f97022>'),b.value.shortcut_commands?(t("\x3c!--[--\x3e"),c(b.value.shortcut_commands,(a,e)=>{t(`<div class="agent-config-item" data-v-f2f97022><div class="three-row" data-v-f2f97022><div class="row" data-v-f2f97022></div><div class="row" data-v-f2f97022></div><div class="row" data-v-f2f97022></div></div><div class="text" data-v-f2f97022>${o(a.name)}</div></div>`)}),t("\x3c!--]--\x3e")):t("\x3c!----\x3e"),t(`</div></div><div class="${i(x.value.length>0?"handle-area hasImage":"handle-area")}" data-v-f2f97022><div class="handle-item" data-v-f2f97022>`),"mobile"===O.value?(t(`<div class="${i(["key-voice-btn",{isHide:""!==h.value.trim()}])}" data-v-f2f97022>`),z.value?(t('<div data-v-f2f97022><div class="keyboard-btn" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-keyboard.png",alt:"键盘",class:"icon"},null,r)),t("</div></div>")):(t('<div class="voice-btn" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-voicebtn.png",alt:"语音",class:"icon"},null,r)),t("</div>")),t("</div>")):t("\x3c!----\x3e"),t('<div class="input-wrapper" data-v-f2f97022>'),z.value?t("\x3c!----\x3e"):t(`<textarea id="message_input" class="message-input" placeholder="发送消息给 AI" data-v-f2f97022>${o(h.value)}</textarea>`),z.value?t('<div class="voice-input" data-v-f2f97022> 按住 说话 </div>'):t("\x3c!----\x3e"),t("</div>"),z.value?t("\x3c!----\x3e"):t('<div class="upload-btn" data-v-f2f97022><input type="file" accept="image/*" multiple autocomplete="off" tabindex="-1" class="semi-upload-hidden-input" data-v-f2f97022></div>'),y.value?(t(`<button class="${i(["send-btn",{disabled:!canSendMessage}])}"${d(!canSendMessage)?" disabled":""} data-v-f2f97022>`),t(n(N,{loading:"lazy",src:canSendMessage?"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-send.png":"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-send-disabled.png",alt:"发送",class:"send-icon"},null,r)),t("</button>")):t('<button class="send-btn" data-v-f2f97022><div class="stop-icon" data-v-f2f97022></div></button>'),t("</div>"),x.value.length>0&&!z.value?(t('<div class="preview-image" data-v-f2f97022>\x3c!--[--\x3e'),c(x.value,(a,e)=>{t('<div class="preview-thumb" data-v-f2f97022>'),t(n(N,{loading:"lazy",src:a.path,alt:"预览",class:"image",onClick:e=>{a.path}},null,r)),t('<div class="delete-btn-wrap" data-v-f2f97022><span class="delete-btn" data-v-f2f97022>×</span></div></div>')}),t("\x3c!--]--\x3e</div>")):t("\x3c!----\x3e"),t(`</div></div><div class="${i(["recording-mask",{isShow:m.value}])}" data-v-f2f97022><div class="recording-content" data-v-f2f97022><div class="recording-circle recording-circle-1" data-v-f2f97022></div><div class="recording-circle recording-circle-2" data-v-f2f97022></div><div class="recording-circle recording-circle-3" data-v-f2f97022></div><div class="recording-icon" data-v-f2f97022>`),t(n(N,{loading:"lazy",src:"https://honghaieim.obs.cn-east-3.myhuaweicloud.com/upload/appicon/coze-voiceing.png",alt:"录音中"},null,r)),t(`</div></div><div class="${i(["recording-cancel",{isCancelStatus:T.value}])}" data-v-f2f97022><div class="text" data-v-f2f97022><div class="hover" data-v-f2f97022></div> ${o(T.value?"松开 取消":"按住 说话")}</div></div></div></div><div class="${i(["history-sessions",{show:$.value}])}" data-v-f2f97022><div class="overlay" data-v-f2f97022></div><div class="history-sessions-title" data-v-f2f97022><div class="text" data-v-f2f97022><div data-v-f2f97022><span class="arrow-left" data-v-f2f97022></span></div><div class="bold" data-v-f2f97022>历史会话</div></div></div><div class="history-sessions-scroll" data-v-f2f97022><div class="history-sessions-content" data-v-f2f97022>\x3c!--[--\x3e`),c(I.value,(a,e)=>{t(`<div class="${i(["history-session",{active:S.value.conversationId===a.conversationId}])}" data-v-f2f97022><div class="history-session-content" data-v-f2f97022><div class="history-session-content-text" data-v-f2f97022>${o(a.content)}</div>`),a.fileList.length>0?(t('<div class="image-wrap" data-v-f2f97022>'),t(n(N,{loading:"lazy",class:"image",src:a.fileList[0].path},null,r)),t("</div>")):t("\x3c!----\x3e"),t("</div></div>")}),t("\x3c!--]--\x3e</div></div></div></div>")}}},r=v.setup;v.setup=(a,e)=>{const s=t.useSSRContext();return(s.modules||(s.modules=new Set)).add("pages/ai.vue"),r?r(a,e):void 0};const f=e(v,[["__scopeId","data-v-f2f97022"]]);export{f as default};
//# sourceMappingURL=ai-ChQ8Y0we.mjs.map
